<script type="module">
    // Firebase импорты
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Конфигурация Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAo5uvpI2B5p2GXLfWXZ29V-Z9cGD8wJ6U",
        authDomain: "whylovly-website.firebaseapp.com",
        projectId: "whylovly-website",
        storageBucket: "whylovly-website-8adcb.appspot.com",
        messagingSenderId: "679128641326",
        appId: "1:679128641326:web:27fe6fa6cd6f1e986cd4bf"
    };

    // Инициализация Firebase
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const db = getFirestore(app);

    // Функция загрузки файла в Storage
    async function uploadFileToStorage(file, category) {
        try {
            const fileRef = storageRef(storage, `${category}/${Date.now()}_${file.name}`);
            const snapshot = await uploadBytes(fileRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            return downloadURL;
        } catch (error) {
            console.error("Ошибка загрузки файла:", error);
            throw error;
        }
    }

    // Функция сохранения поста в Firestore
    async function savePost(postData) {
        try {
            const docRef = await addDoc(collection(db, 'posts'), {
                ...postData,
                timestamp: new Date().toISOString(),
                likes: 0,
                comments: []
            });
            return docRef.id;
        } catch (error) {
            console.error("Ошибка сохранения поста:", error);
            throw error;
        }
    }

    // Обработчик отправки формы
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const submitButton = this.querySelector('button[type="submit"]');
        const progressBar = document.querySelector('.progress');
        
        try {
            submitButton.disabled = true;
            progressBar.style.width = '10%';

            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;
            let fileURL = '';

            // Обработка видео
            if (category === 'video') {
                fileURL = document.getElementById('youtubeLink').value;
                if (!fileURL) throw new Error('Укажите ссылку на YouTube');
            } 
            // Обработка фото/музыки
            else {
                const fileInput = document.getElementById('fileInput');
                if (!fileInput.files.length) throw new Error('Выберите файл');
                
                progressBar.style.width = '30%';
                fileURL = await uploadFileToStorage(fileInput.files[0], category);
            }

            progressBar.style.width = '60%';

            // Сохраняем пост
            const postData = {
                category,
                fileURL,
                description,
                type: category,
                createdAt: new Date().toISOString()
            };

            await savePost(postData);
            progressBar.style.width = '100%';

            alert('Пост успешно опубликован!');
            this.reset();
            document.getElementById('imagePreview').innerHTML = '';

        } catch (error) {
            alert(`Ошибка: ${error.message}`);
            console.error(error);
        } finally {
            submitButton.disabled = false;
            setTimeout(() => {
                progressBar.style.width = '0%';
            }, 1000);
        }
    });

    // Функция получения всех постов
    async function loadPosts() {
        try {
            const querySnapshot = await getDocs(collection(db, 'posts'));
            const posts = [];
            querySnapshot.forEach((doc) => {
                posts.push({ id: doc.id, ...doc.data() });
            });
            return posts;
        } catch (error) {
            console.error("Ошибка загрузки постов:", error);
            throw error;
        }
    }

    // Добавляем вкладку управления постами
    const postsTab = document.createElement('div');
    postsTab.id = 'managePosts';
    postsTab.className = 'tab-content';
    postsTab.innerHTML = `
        <div class="form-group">
            <h3>Управление постами</h3>
            <div id="postsList"></div>
        </div>
    `;
    document.body.appendChild(postsTab);

    // Добавляем кнопку в меню
    const tabsContainer = document.querySelector('.admin-tabs');
    const manageButton = document.createElement('button');
    manageButton.className = 'tab-button';
    manageButton.onclick = () => showTab('managePosts');
    manageButton.textContent = 'Управление постами';
    tabsContainer.appendChild(manageButton);

    // Функция отображения постов
    async function displayPosts() {
        const postsContainer = document.getElementById('postsList');
        try {
            const posts = await loadPosts();
            postsContainer.innerHTML = posts.map(post => `
                <div class="post-item" style="margin: 10px 0; padding: 10px; border: 1px solid var(--neon-color); border-radius: 5px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${post.category}</strong>
                            <p>${post.description}</p>
                            <small>${new Date(post.createdAt).toLocaleString()}</small>
                        </div>
                        <button onclick="deletePost('${post.id}')" style="background: #ff4444; margin-left: 10px;">
                            Удалить
                        </button>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            postsContainer.innerHTML = `<p style="color: red;">Ошибка загрузки постов: ${error.message}</p>`;
        }
    }

    // Функция удаления поста
    window.deletePost = async function(postId) {
        if (confirm('Вы уверены, что хотите удалить этот пост?')) {
            try {
                await deleteDoc(doc(db, 'posts', postId));
                alert('Пост удален');
                displayPosts(); // Обновляем список
            } catch (error) {
                alert(`Ошибка удаления: ${error.message}`);
            }
        }
    };

    // Загружаем посты при открытии вкладки
    document.querySelector('[onclick="showTab(\'managePosts\')"]').addEventListener('click', displayPosts);
</script>
