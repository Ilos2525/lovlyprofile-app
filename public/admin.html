<script type="module">
    // Firebase импорты
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Инициализация Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAo5uvpI2B5p2GXLfWXZ29V-Z9cGD8wJ6U",
        authDomain: "whylovly-website.firebaseapp.com",
        projectId: "whylovly-website",
        storageBucket: "whylovly-website-8adcb.appspot.com",
        messagingSenderId: "679128641326",
        appId: "1:679128641326:web:27fe6fa6cd6f1e986cd4bf"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const db = getFirestore(app);

    // Обработчик формы загрузки
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Начало загрузки'); // Отладочный вывод

        const submitButton = this.querySelector('button[type="submit"]');
        const progressBar = document.querySelector('.progress');
        
        try {
            submitButton.disabled = true;
            progressBar.style.width = '10%';

            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;
            const fileInput = document.getElementById('fileInput');
            const youtubeLink = document.getElementById('youtubeLink').value;

            console.log('Данные формы:', { category, description }); // Отладочный вывод

            let fileURL = '';

            if (category === 'video') {
                if (!youtubeLink) {
                    throw new Error('Укажите ссылку на YouTube');
                }
                fileURL = youtubeLink;
                console.log('YouTube ссылка:', fileURL); // Отладочный вывод
            } else {
                if (!fileInput.files.length) {
                    throw new Error('Выберите файл');
                }

                const file = fileInput.files[0];
                console.log('Загружаемый файл:', file.name); // Отладочный вывод

                // Загрузка в Storage
                const fileRef = storageRef(storage, `${category}/${Date.now()}_${file.name}`);
                console.log('Начало загрузки в Storage'); // Отладочный вывод
                
                const snapshot = await uploadBytes(fileRef, file);
                console.log('Файл загружен в Storage'); // Отладочный вывод
                
                fileURL = await getDownloadURL(snapshot.ref);
                console.log('Получен URL файла:', fileURL); // Отладочный вывод
            }

            progressBar.style.width = '50%';

            // Сохранение в Firestore
            const postData = {
                category,
                fileURL,
                description,
                createdAt: new Date().toISOString()
            };

            console.log('Сохранение в Firestore:', postData); // Отладочный вывод
            
            const docRef = await addDoc(collection(db, 'posts'), postData);
            console.log('Документ сохранен с ID:', docRef.id); // Отладочный вывод

            progressBar.style.width = '100%';
            alert('Пост успешно опубликован!');
            
            // Сброс формы
            this.reset();
            document.getElementById('imagePreview').innerHTML = '';

        } catch (error) {
            console.error('Ошибка при загрузке:', error); // Отладочный вывод
            alert(`Ошибка: ${error.message}`);
        } finally {
            submitButton.disabled = false;
            setTimeout(() => {
                progressBar.style.width = '0%';
            }, 1000);
        }
    });

    // Обработчик выбора категории
    document.getElementById('category').addEventListener('change', function(e) {
        const isVideo = e.target.value === 'video';
        document.getElementById('fileInputGroup').style.display = isVideo ? 'none' : 'block';
        document.getElementById('youtubeLinkGroup').style.display = isVideo ? 'block' : 'none';
    });

    // Предпросмотр изображений
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').innerHTML = 
                    `<img src="${e.target.result}" style="max-width: 200px;">`;
            };
            reader.readAsDataURL(file);
        }
    });

    // Функция переключения вкладок
    window.showTab = function(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
    };
</script>
